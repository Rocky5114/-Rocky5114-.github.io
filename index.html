<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>辽宁工程技术大学成绩绩点计算器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.3/tesseract.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a3a6c 0%, #2c5282 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
        }
        
        header p {
            font-size: 1.2rem;
            max-width: 700px;
            margin: 0 auto;
            opacity: 0.9;
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .logo-icon {
            font-size: 2.5rem;
            color: #FFD700;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 25px;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            font-size: 1.6rem;
            color: #1a3a6c;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e6ed;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: #2c5282;
        }
        
        .input-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            flex: 1;
            min-width: 250px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        
        .btn {
            background: #2b6cb0;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: #2c5282;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-add {
            background: #38a169;
        }
        
        .btn-add:hover {
            background: #2f855a;
        }
        
        .btn-calculate {
            background: #3182ce;
        }
        
        .btn-calculate:hover {
            background: #2b6cb0;
        }
        
        .btn-reset {
            background: #e53e3e;
        }
        
        .btn-reset:hover {
            background: #c53030;
        }
        
        .btn-example {
            background: #9f7aea;
        }
        
        .btn-example:hover {
            background: #805ad5;
        }
        
        .btn-import {
            background: #d69e2e;
        }
        
        .btn-import:hover {
            background: #b7791f;
        }
        
        .btn-save {
            background: #38a169;
            padding: 5px 10px;
            font-size: 0.9rem;
        }
        
        .btn-save:hover {
            background: #2f855a;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 16px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        thead tr {
            background-color: #2c5282;
            color: white;
            text-align: left;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: center;
        }
        
        th:first-child, td:first-child {
            text-align: left;
        }
        
        tbody tr {
            border-bottom: 1px solid #e2e8f0;
        }
        
        tbody tr:nth-of-type(even) {
            background-color: #f7fafc;
        }
        
        tbody tr:last-of-type {
            border-bottom: 2px solid #2c5282;
        }
        
        tbody tr:hover {
            background-color: #ebf8ff;
        }
        
        .result-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 20px;
        }
        
        .result-box {
            flex: 1;
            min-width: 250px;
            background: linear-gradient(135deg, #2b6cb0 0%, #3182ce 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        .result-value {
            font-size: 3.5rem;
            font-weight: 700;
            margin: 15px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .result-label {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .instructions {
            background: #f7fafc;
            border-left: 5px solid #2c5282;
            padding: 20px;
            border-radius: 0 8px 8px 0;
            margin: 25px 0;
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: #2c5282;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-left: 25px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        
        .grade-table {
            overflow-x: auto;
        }
        
        .grade-table table {
            min-width: 700px;
        }
        
        footer {
            text-align: center;
            color: white;
            padding: 30px 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .input-section {
                flex-direction: column;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .result-container {
                flex-direction: column;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
        }
        
        .delete-btn {
            color: #e53e3e;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }
        
        .delete-btn:hover {
            transform: scale(1.2);
        }
        
        .edit-btn {
            color: #3182ce;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
            margin-right: 10px;
        }
        
        .edit-btn:hover {
            transform: scale(1.2);
        }
        
        .gpa-indicator {
            font-size: 1rem;
            margin-top: 5px;
            font-weight: 600;
        }
        
        .gpa-excellent {
            color: #38a169;
        }
        
        .gpa-good {
            color: #38a169;
        }
        
        .gpa-medium {
            color: #dd6b20;
        }
        
        .gpa-low {
            color: #e53e3e;
        }
        
        .input-error {
            border-color: #e53e3e !important;
        }
        
        .error-message {
            color: #e53e3e;
            font-size: 0.9rem;
            margin-top: 5px;
            display: none;
        }
        
        .import-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 2px dashed #cbd5e0;
        }
        
        .import-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .import-options {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .import-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .import-option:hover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        
        .import-option.active {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        
        .import-option i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #4299e1;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-label {
            display: block;
            padding: 15px;
            background: #edf2f7;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-label:hover {
            background: #e2e8f0;
        }
        
        .ocr-preview {
            margin-top: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .ocr-text {
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4299e1;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-text {
            text-align: center;
            color: #4a5568;
            margin: 5px 0;
        }
        
        .import-result {
            background: #f0fff4;
            border-left: 4px solid #48bb78;
            padding: 15px;
            margin-top: 15px;
            border-radius: 0 4px 4px 0;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background: white;
            border-bottom: 2px solid white;
            margin-bottom: -2px;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* 标记原始成绩和转换后的成绩 */
        .original-score {
            font-style: italic;
        }
        
        .converted-score {
            font-weight: bold;
        }
        
        /* 计算结果卡片特殊样式 - 消除底部空白 */
        #result-card {
            padding-bottom: 15px; /* 减少底部内边距 */
        }
        
        /* 编辑模式输入框样式 */
        .edit-input {
            width: 100%;
            padding: 5px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-graduation-cap logo-icon"></i>
                <h1>辽宁工程技术大学成绩绩点计算器</h1>
            </div>
            <p>精准计算加权平均分和平均学分绩点（GPA），支持文件导入和成绩识别功能</p>
        </header>
        
        <div class="card">
            <div class="tab-container">
                <div class="tab active" data-tab="manual">手动输入</div>
                <div class="tab" data-tab="import">文件导入</div>
            </div>
            
            <div class="tab-content active" id="manual-tab">
                <h2 class="card-title"><i class="fas fa-book"></i> 添加课程成绩</h2>
                
                <div class="input-section">
                    <div class="input-group">
                        <label for="courseName">课程名称（可选）</label>
                        <input type="text" id="courseName" placeholder="例如：操作系统，可不填">
                        <div class="error-message" id="nameError">请输入课程名称（可选）</div>
                    </div>
                    
                    <div class="input-group">
                        <label for="courseScore">最终得分</label>
                        <input type="text" id="courseScore" placeholder="例如：66 或 '优秀'">
                        <div class="error-message" id="scoreError">请输入有效的成绩</div>
                    </div>
                    
                    <div class="input-group">
                        <label for="courseCredit">学分</label>
                        <input type="number" id="courseCredit" min="0.25" max="10" step="0.25" placeholder="例如：3.5" value="2">
                        <div class="error-message" id="creditError">请输入有效的学分(0.25-10)</div>
                    </div>
                    
                    <div class="input-group">
                        <label for="scoreType">成绩类型</label>
                        <select id="scoreType">
                            <option value="percent">百分制</option>
                            <option value="five">五级分制</option>
                            <option value="two">二级分制</option>
                        </select>
                    </div>
                </div>
                
                <button id="addCourse" class="btn btn-add">
                    <i class="fas fa-plus"></i> 添加课程
                </button>
            </div>
            
            <div class="tab-content" id="import-tab">
                <h2 class="card-title"><i class="fas fa-file-import"></i> 导入成绩单</h2>
                
                <div class="import-section">
                    <div class="import-header">
                        <h3>选择导入方式</h3>
                    </div>
                    
                    <div class="import-options">
                        <div class="import-option active" data-type="image">
                            <i class="fas fa-file-image"></i>
                            <div>图片识别</div>
                        </div>
                        <div class="import-option" data-type="pdf">
                            <i class="fas fa-file-pdf"></i>
                            <div>PDF文件</div>
                        </div>
                    </div>
                    
                    <div class="file-input-container">
                        <input type="file" id="fileInput" class="file-input" accept=".jpg,.jpeg,.png,.pdf">
                        <label for="fileInput" class="file-label">
                            <i class="fas fa-cloud-upload-alt"></i> 点击或拖放文件到此处
                        </label>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress" id="progressBar"></div>
                    </div>
                    <div class="status-text" id="statusText">等待文件上传...</div>
                    
                    <div class="ocr-preview" id="ocrPreview" style="display:none;">
                        <h4>识别结果预览</h4>
                        <pre class="ocr-text" id="ocrText"></pre>
                        <div class="extracted-data" id="extractedData" style="margin-top:15px;">
                            <h4>提取的课程数据（可编辑）</h4>
                            <div id="extractedTable" style="margin-top:10px;"></div>
                        </div>
                    </div>
                    
                    <div class="import-result" id="importResult" style="display:none;">
                        <h4>导入结果</h4>
                        <div id="importStatus">成功导入 <span id="importCount">0</span> 门课程</div>
                        <button id="confirmImport" class="btn btn-add" style="margin-top:10px;">
                            <i class="fas fa-check"></i> 确认导入
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title"><i class="fas fa-list"></i> 已添加课程</h2>
            
            <div class="grade-table">
                <table id="coursesTable">
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>最终得分</th>
                            <th>转换后百分制成绩</th>
                            <th>学分</th>
                            <th>绩点</th>
                            <th>学分绩</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="coursesBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #718096;">暂无课程数据，请添加课程</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="buttons">
                <button id="calculate" class="btn btn-calculate">
                    <i class="fas fa-calculator"></i> 计算成绩
                </button>
                <button id="reset" class="btn btn-reset">
                    <i class="fas fa-trash-alt"></i> 重置所有
                </button>
                <button id="loadExample" class="btn btn-example">
                    <i class="fas fa-lightbulb"></i> 加载示例
                </button>
            </div>
        </div>
        
        <!-- 为计算结果卡片添加ID以便单独设置样式 -->
        <div class="card" id="result-card">
            <h2 class="card-title"><i class="fas fa-chart-line"></i> 计算结果</h2>
            
            <div class="result-container">
                <div class="result-box">
                    <div class="result-label">加权平均分</div>
                    <div id="weightedAverage" class="result-value">0.0000</div>
                    <div>∑(学分×转换后百分制成绩) / ∑学分</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">平均学分绩点</div>
                    <div id="gpaResult" class="result-value">0.0000</div>
                    <div>∑(绩点×学分) / ∑学分</div>
                    <div id="gpaIndicator" class="gpa-indicator">-</div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使用说明与绩点转换规则</h3>
            <ul>
                <li><strong>最终成绩</strong>对应成绩单中的"得分"列，直接显示输入值</li>
                <li><strong>转换后百分制成绩</strong>根据成绩类型自动转换：
                    <ul>
                        <li>百分制成绩保持不变</li>
                        <li>五级分制和二级分制按下方规则转换</li>
                    </ul>
                </li>
                <li>课程名称为可选字段，不输入时将自动以"课程1、课程2..."编号</li>
                <li>已添加课程可点击编辑按钮进行修改</li>
                <li>绩点转换规则：根据辽宁工程技术大学官方标准（见下方表格）</li>
            </ul>
            
            <div class="grade-table">
                <table>
                    <thead>
                        <tr>
                            <th>百分制成绩</th>
                            <th>五级分制</th>
                            <th>二级分制</th>
                            <th>绩点</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>100-95</td>
                            <td>优秀 → 95</td>
                            <td>合格 → 85</td>
                            <td>4.5</td>
                        </tr>
                        <tr>
                            <td>94-90</td>
                            <td>优秀 → 95</td>
                            <td>合格 → 85</td>
                            <td>4.0</td>
                        </tr>
                        <tr>
                            <td>89-85</td>
                            <td>良好 → 85</td>
                            <td>合格 → 85</td>
                            <td>3.5</td>
                        </tr>
                        <tr>
                            <td>84-80</td>
                            <td>良好 → 85</td>
                            <td>合格 → 85</td>
                            <td>3.0</td>
                        </tr>
                        <tr>
                            <td>79-75</td>
                            <td>中等 → 75</td>
                            <td>合格 → 85</td>
                            <td>2.5</td>
                        </tr>
                        <tr>
                            <td>74-70</td>
                            <td>中等 → 75</td>
                            <td>合格 → 85</td>
                            <td>2.0</td>
                        </tr>
                        <tr>
                            <td>69-65</td>
                            <td>及格 → 65</td>
                            <td>合格 → 85</td>
                            <td>1.5</td>
                        </tr>
                        <tr>
                            <td>64-60</td>
                            <td>及格 → 65</td>
                            <td>合格 → 85</td>
                            <td>1.0</td>
                        </tr>
                        <tr>
                            <td>59以下</td>
                            <td>不及格 → 0</td>
                            <td>不合格 → 0</td>
                            <td>0.0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <p>© 2025 辽宁工程技术大学成绩绩点计算器 | 数据计算基于学校官方绩点转换标准</p>
        </footer>
    </div>

    <script>
        // 课程数据存储
        let courses = [];
        
        // 格式化数字显示：整数显示整数，有限小数显示实际位数，无限小数保留四位
        function formatNumber(num) {
            // 检查是否为整数
            if (Number.isInteger(num)) {
                return num.toString();
            }
            
            // 尝试转换为字符串，检查小数位数
            let numStr = num.toString();
            if (numStr.includes('.')) {
                const decimalPart = numStr.split('.')[1];
                // 如果小数部分较短（4位或更少），直接显示
                if (decimalPart.length <= 4) {
                    return numStr;
                }
            }
            
            // 否则保留四位小数
            return num.toFixed(4);
        }
        
        // DOM元素
        const coursesBody = document.getElementById('coursesBody');
        const addCourseBtn = document.getElementById('addCourse');
        const calculateBtn = document.getElementById('calculate');
        const resetBtn = document.getElementById('reset');
        const loadExampleBtn = document.getElementById('loadExample');
        const confirmImportBtn = document.getElementById('confirmImport');
        const fileInput = document.getElementById('fileInput');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const ocrPreview = document.getElementById('ocrPreview');
        const ocrText = document.getElementById('ocrText');
        const importResult = document.getElementById('importResult');
        const importStatus = document.getElementById('importStatus');
        const importCount = document.getElementById('importCount');
        const extractedTable = document.getElementById('extractedTable');
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 绑定标签页切换
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // 绑定导入选项切换
            document.querySelectorAll('.import-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.import-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    
                    // 更新文件输入接受类型
                    if (option.dataset.type === 'image') {
                        fileInput.accept = '.jpg,.jpeg,.png';
                    } else {
                        fileInput.accept = '.pdf';
                    }
                });
            });
            
            // 绑定文件上传
            fileInput.addEventListener('change', handleFileUpload);
            
            // 绑定确认导入按钮
            confirmImportBtn.addEventListener('click', confirmImport);
            
            // 绑定其他按钮
            addCourseBtn.addEventListener('click', addCourse);
            calculateBtn.addEventListener('click', calculateResults);
            resetBtn.addEventListener('click', resetAll);
            loadExampleBtn.addEventListener('click', loadExample);
        });
        
        // 五级分制转换为百分制的映射表
        const fiveLevelToPercent = {
            '优秀': 95,
            '良好': 85,
            '中等': 75,
            '及格': 65,
            '不及格': 0
        };
        
        // 二级分制转换为百分制的映射表
        const twoLevelToPercent = {
            '合格': 85,
            '不合格': 0
        };
        
        // 绩点转换函数：根据转换后的百分制成绩计算绩点
        function calculateGpa(percentScore) {
            if (percentScore >= 95) return 4.5;
            if (percentScore >= 90) return 4.0;
            if (percentScore >= 85) return 3.5;
            if (percentScore >= 80) return 3.0;
            if (percentScore >= 75) return 2.5;
            if (percentScore >= 70) return 2.0;
            if (percentScore >= 65) return 1.5;
            if (percentScore >= 60) return 1.0;
            return 0.0;
        }
        
        // 根据原始成绩和类型，计算转换后的百分制成绩
        function convertToPercentScore(originalScore, scoreType) {
            if (scoreType === 'percent') {
                // 百分制成绩保持不变
                return parseFloat(originalScore);
            } else if (scoreType === 'five') {
                // 五级分制按映射表转换
                return fiveLevelToPercent[originalScore] || 0;
            } else if (scoreType === 'two') {
                // 二级分制按映射表转换
                return twoLevelToPercent[originalScore] || 0;
            }
            return 0;
        }
        
        // 自动判断成绩类型
        function determineScoreType(scoreText) {
            // 检查是否为五级分制
            if (Object.keys(fiveLevelToPercent).includes(scoreText)) {
                return 'five';
            }
            
            // 检查是否为二级分制
            if (Object.keys(twoLevelToPercent).includes(scoreText)) {
                return 'two';
            }
            
            // 检查是否为百分制数字
            const num = parseFloat(scoreText);
            if (!isNaN(num) && num >= 0 && num <= 100) {
                return 'percent';
            }
            
            // 默认视为百分制
            return 'percent';
        }
        
        // 验证输入
        function validateInput() {
            const courseName = document.getElementById('courseName').value.trim();
            const originalScore = document.getElementById('courseScore').value.trim(); // 原始成绩
            const courseCredit = parseFloat(document.getElementById('courseCredit').value);
            const scoreType = document.getElementById('scoreType').value;
            
            let isValid = true;
            
            // 重置错误状态
            document.getElementById('courseName').classList.remove('input-error');
            document.getElementById('courseScore').classList.remove('input-error');
            document.getElementById('courseCredit').classList.remove('input-error');
            document.getElementById('nameError').style.display = 'none';
            document.getElementById('scoreError').style.display = 'none';
            document.getElementById('creditError').style.display = 'none';
            
            // 课程名称可以为空，不需要验证
            
            // 验证原始成绩
            if (!originalScore) {
                document.getElementById('courseScore').classList.add('input-error');
                document.getElementById('scoreError').style.display = 'block';
                isValid = false;
            } else if (scoreType === 'percent') {
                const scoreNum = parseFloat(originalScore);
                if (isNaN(scoreNum)) {
                    document.getElementById('courseScore').classList.add('input-error');
                    document.getElementById('scoreError').textContent = '百分制成绩必须为数字';
                    document.getElementById('scoreError').style.display = 'block';
                    isValid = false;
                } else if (scoreNum < 0 || scoreNum > 100) {
                    document.getElementById('courseScore').classList.add('input-error');
                    document.getElementById('scoreError').textContent = '成绩必须在0-100之间';
                    document.getElementById('scoreError').style.display = 'block';
                    isValid = false;
                }
            } else if (scoreType === 'five') {
                if (!Object.keys(fiveLevelToPercent).includes(originalScore)) {
                    document.getElementById('courseScore').classList.add('input-error');
                    document.getElementById('scoreError').textContent = '请输入有效的五级分制成绩（优秀/良好/中等/及格/不及格）';
                    document.getElementById('scoreError').style.display = 'block';
                    isValid = false;
                }
            } else if (scoreType === 'two') {
                if (!Object.keys(twoLevelToPercent).includes(originalScore)) {
                    document.getElementById('courseScore').classList.add('input-error');
                    document.getElementById('scoreError').textContent = '请输入有效的二级分制成绩（合格/不合格）';
                    document.getElementById('scoreError').style.display = 'block';
                    isValid = false;
                }
            }
            
            // 验证学分
            if (isNaN(courseCredit) || courseCredit < 0.25 || courseCredit > 10) {
                document.getElementById('courseCredit').classList.add('input-error');
                document.getElementById('creditError').style.display = 'block';
                isValid = false;
            }
            
            return isValid;
        }
        
        // 添加课程
        function addCourse() {
            let courseName = document.getElementById('courseName').value.trim();
            const originalScore = document.getElementById('courseScore').value.trim(); // 原始成绩
            const courseCredit = parseFloat(document.getElementById('courseCredit').value);
            const scoreType = document.getElementById('scoreType').value;
            
            if (!validateInput()) return;
            
            // 如果课程名称为空，自动生成序号名称
            if (!courseName) {
                courseName = `课程${courses.length + 1}`;
            }
            
            // 计算转换后的百分制成绩和绩点
            const percentScore = convertToPercentScore(originalScore, scoreType);
            const gpa = calculateGpa(percentScore);
            
            // 添加到课程数组
            courses.push({
                name: courseName,
                originalScore: originalScore,  // 最终成绩
                percentScore: percentScore,    // 转换后的百分制成绩
                credit: courseCredit,
                scoreType: scoreType,          // 记录成绩类型
                gpa: gpa,
                creditGpa: gpa * courseCredit
            });
            
            // 更新表格
            updateCoursesTable();
            
            // 清空输入
            document.getElementById('courseName').value = '';
            document.getElementById('courseScore').value = '';
        }
        
        // 更新课程表格
        function updateCoursesTable() {
            coursesBody.innerHTML = '';
            
            if (courses.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center; padding: 20px; color: #718096;">暂无课程数据，请添加课程</td>`;
                coursesBody.appendChild(row);
                return;
            }
            
            // 更新自动生成的课程名称（如果有新增或删除）
            courses.forEach((course, index) => {
                if (course.name.startsWith('课程') && !isNaN(parseInt(course.name.substring(2)))) {
                    course.name = `课程${index + 1}`;
                }
            });
            
            courses.forEach((course, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="course-name-${index}">${course.name}</td>
                    <td class="original-score course-score-${index}">${course.originalScore}</td>
                    <td class="converted-score">${formatNumber(course.percentScore)}</td>
                    <td class="course-credit-${index}">${course.credit}</td>
                    <td>${formatNumber(course.gpa)}</td>
                    <td>${formatNumber(course.creditGpa)}</td>
                    <td>
                        <button class="edit-btn" data-index="${index}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                coursesBody.appendChild(row);
            });
            
            // 添加删除事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    courses.splice(index, 1);
                    updateCoursesTable();
                });
            });
            
            // 添加编辑事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    enableEditing(index);
                });
            });
        }
        
        // 启用编辑模式
        function enableEditing(index) {
            const course = courses[index];
            
            // 获取当前行的各个单元格
            const nameCell = document.querySelector(`.course-name-${index}`);
            const scoreCell = document.querySelector(`.course-score-${index}`);
            const creditCell = document.querySelector(`.course-credit-${index}`);
            const actionCell = nameCell.parentElement.querySelector('td:last-child');
            
            // 保存原始内容
            const originalContent = {
                name: nameCell.textContent,
                score: scoreCell.textContent,
                credit: creditCell.textContent,
                actions: actionCell.innerHTML
            };
            
            // 替换为输入框
            nameCell.innerHTML = `<input type="text" value="${course.name}" class="edit-input course-name-input">`;
            scoreCell.innerHTML = `<input type="text" value="${course.originalScore}" class="edit-input course-score-input">`;
            creditCell.innerHTML = `<input type="number" min="0.25" max="10" step="0.25" value="${course.credit}" class="edit-input course-credit-input">`;
            actionCell.innerHTML = `
                <button class="btn btn-save save-btn" data-index="${index}">
                    <i class="fas fa-check"></i> 保存
                </button>
                <button class="btn btn-reset cancel-btn" data-index="${index}">
                    <i class="fas fa-times"></i> 取消
                </button>
            `;
            
            // 添加保存按钮事件
            actionCell.querySelector('.save-btn').addEventListener('click', () => {
                saveEditing(index);
            });
            
            // 添加取消按钮事件
            actionCell.querySelector('.cancel-btn').addEventListener('click', () => {
                // 恢复原始内容
                nameCell.textContent = originalContent.name;
                scoreCell.textContent = originalContent.score;
                creditCell.textContent = originalContent.credit;
                actionCell.innerHTML = originalContent.actions;
                
                // 重新绑定事件
                actionCell.querySelector('.edit-btn').addEventListener('click', () => {
                    enableEditing(index);
                });
                
                actionCell.querySelector('.delete-btn').addEventListener('click', () => {
                    courses.splice(index, 1);
                    updateCoursesTable();
                });
            });
        }
        
        // 保存编辑内容
        function saveEditing(index) {
            const nameInput = document.querySelector(`.course-name-${index} .course-name-input`);
            const scoreInput = document.querySelector(`.course-score-${index} .course-score-input`);
            const creditInput = document.querySelector(`.course-credit-${index} .course-credit-input`);
            
            if (!nameInput || !scoreInput || !creditInput) return;
            
            // 获取输入值
            let newName = nameInput.value.trim();
            const newScore = scoreInput.value.trim();
            const newCredit = parseFloat(creditInput.value);
            
            // 验证输入
            if (!newScore) {
                alert('请输入成绩');
                return;
            }
            
            if (isNaN(newCredit) || newCredit < 0.25 || newCredit > 10) {
                alert('请输入有效的学分(0.25-10)');
                return;
            }
            
            // 确定成绩类型
            const scoreType = determineScoreType(newScore);
            
            // 对百分制成绩进行额外验证
            if (scoreType === 'percent') {
                const scoreNum = parseFloat(newScore);
                if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > 100) {
                    alert('请输入有效的百分制成绩(0-100)');
                    return;
                }
            }
            
            // 如果名称为空，使用自动编号
            if (!newName) {
                newName = `课程${index + 1}`;
            }
            
            // 更新课程数据
            const percentScore = convertToPercentScore(newScore, scoreType);
            const gpa = calculateGpa(percentScore);
            
            courses[index] = {
                name: newName,
                originalScore: newScore,
                percentScore: percentScore,
                credit: newCredit,
                scoreType: scoreType,
                gpa: gpa,
                creditGpa: gpa * newCredit
            };
            
            // 更新表格
            updateCoursesTable();
        }
        
        // 计算成绩
        function calculateResults() {
            if (courses.length === 0) {
                alert('请添加至少一门课程');
                return;
            }
            
            // 计算总学分、总加权分、总学分绩
            let totalCredits = 0;
            let totalWeightedScore = 0;
            let totalCreditGpa = 0;
            
            courses.forEach(course => {
                totalCredits += course.credit;
                totalWeightedScore += course.percentScore * course.credit; // 使用转换后的百分制成绩
                totalCreditGpa += course.creditGpa; // 绩点×学分
            });
            
            const weightedAverage = totalWeightedScore / totalCredits;
            const gpa = totalCreditGpa / totalCredits;
            
            // 更新结果显示（精确到小数点后四位）
            document.getElementById('weightedAverage').textContent = weightedAverage.toFixed(4);
            document.getElementById('gpaResult').textContent = gpa.toFixed(4);
            
            // 更新GPA评价
            const gpaIndicator = document.getElementById('gpaIndicator');
            if (gpa >= 4.0) {
                gpaIndicator.textContent = '成绩优秀';
                gpaIndicator.className = 'gpa-indicator gpa-excellent';
            } else if (gpa >= 3.0) {
                gpaIndicator.textContent = '成绩良好';
                gpaIndicator.className = 'gpa-indicator gpa-good';
            } else if (gpa >= 2.0) {
                gpaIndicator.textContent = '成绩中等';
                gpaIndicator.className = 'gpa-indicator gpa-medium';
            } else {
                gpaIndicator.textContent = '需要努力';
                gpaIndicator.className = 'gpa-indicator gpa-low';
            }
        }
        
        // 重置所有
        function resetAll() {
            if (confirm('确定要重置所有数据吗？')) {
                courses = [];
                updateCoursesTable();
                document.getElementById('weightedAverage').textContent = '0.0000';
                document.getElementById('gpaResult').textContent = '0.0000';
                document.getElementById('gpaIndicator').textContent = '-';
                document.getElementById('gpaIndicator').className = 'gpa-indicator';
            }
        }
        
        // 加载示例数据（模拟成绩单样例）
        function loadExample() {
            // 模拟样例数据，包含不同类型的成绩
            courses = [
                { 
                    name: '操作系统', 
                    originalScore: '66', 
                    percentScore: 66, 
                    credit: 3.5, 
                    scoreType: 'percent',
                    gpa: 1.0, 
                    creditGpa: 3.5 
                },
                { 
                    name: '数据库原理与应用', 
                    originalScore: '71', 
                    percentScore: 71, 
                    credit: 3.5, 
                    scoreType: 'percent',
                    gpa: 2.0, 
                    creditGpa: 7.0 
                },
                { 
                    name: '马克思主义基本原理', 
                    originalScore: '优秀', 
                    percentScore: 95, 
                    credit: 3, 
                    scoreType: 'five',
                    gpa: 4.5, 
                    creditGpa: 13.5 
                },
                { 
                    name: '形势与政策', 
                    originalScore: '合格', 
                    percentScore: 85, 
                    credit: 0.5, 
                    scoreType: 'two',
                    gpa: 3.5, 
                    creditGpa: 1.75 
                },
                { 
                    name: '大学英语', 
                    originalScore: '82', 
                    percentScore: 82, 
                    credit: 4, 
                    scoreType: 'percent',
                    gpa: 3.0, 
                    creditGpa: 12.0 
                }
            ];
            
            updateCoursesTable();
        }
        
        // 文件上传处理
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileType = document.querySelector('.import-option.active').dataset.type;
            statusText.textContent = "处理中...";
            progressBar.style.width = "30%";
            
            if (fileType === 'image') {
                processImage(file);
            } else {
                processPDF(file);
            }
        }
        
        // 处理图片文件（OCR识别）
        function processImage(file) {
            statusText.textContent = "正在识别图片内容...";
            progressBar.style.width = "50%";
            
            // 使用更高精度的OCR配置
            const config = {
                logger: m => {
                    // 更新进度
                    if (m.status === 'recognizing text') {
                        const progress = 50 + (m.progress * 50);
                        progressBar.style.width = `${progress}%`;
                        statusText.textContent = `正在识别: ${Math.round(m.progress * 100)}%`;
                    }
                },
                // 提高识别精度的参数
                tessedit_char_whitelist: '0123456789.优秀良好中等及格不及格合格不合格abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ ',
                preserve_interword_spaces: '1'
            };
            
            Tesseract.recognize(
                file,
                'chi_sim+eng',
                config
            ).then(({ data: { text } }) => {
                progressBar.style.width = "100%";
                statusText.textContent = "识别完成";
                
                ocrText.textContent = text;
                ocrPreview.style.display = "block";
                
                // 从识别文本提取课程信息
                const extractedCourses = extractCoursesFromText(text);
                if (extractedCourses.length > 0) {
                    displayExtractedCourses(extractedCourses);
                    importCount.textContent = extractedCourses.length;
                    importStatus.innerHTML = `成功提取到 <strong>${extractedCourses.length}</strong> 门课程`;
                    importResult.style.display = "block";
                    
                    // 暂存提取的课程
                    window.extractedCourses = extractedCourses;
                } else {
                    statusText.textContent = "未识别到成绩信息，请手动添加";
                    extractedTable.innerHTML = "<p>未提取到课程数据，请检查文件清晰度或尝试手动输入。</p>";
                }
            });
        }
        
        // 处理PDF文件
        function processPDF(file) {
            statusText.textContent = "正在解析PDF文件...";
            progressBar.style.width = "50%";
            
            const fileReader = new FileReader();
            
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                
                // 使用pdf.js解析PDF
                pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                    const totalPages = pdf.numPages;
                    let text = "";
                    let pageCounter = 0;
                    
                    // 逐页提取文本
                    const extractPageText = (pageNum) => {
                        return pdf.getPage(pageNum).then(page => {
                            return page.getTextContent().then(textContent => {
                                let pageText = textContent.items.map(item => item.str).join(' ');
                                text += pageText + "\n";
                                pageCounter++;
                                
                                // 更新进度
                                progressBar.style.width = `${50 + (pageCounter / totalPages) * 50}%`;
                                statusText.textContent = `正在解析第 ${pageCounter}/${totalPages} 页...`;
                                
                                // 继续下一页
                                if (pageCounter < totalPages) {
                                    return extractPageText(pageNum + 1);
                                }
                                return text;
                            });
                        });
                    };
                    
                    // 开始提取
                    extractPageText(1).then(fullText => {
                        progressBar.style.width = "100%";
                        statusText.textContent = "解析完成";
                        
                        ocrText.textContent = fullText;
                        ocrPreview.style.display = "block";
                        
                        // 从文本提取课程信息
                        const extractedCourses = extractCoursesFromText(fullText);
                        if (extractedCourses.length > 0) {
                            displayExtractedCourses(extractedCourses);
                            importCount.textContent = extractedCourses.length;
                            importStatus.innerHTML = `成功提取到 <strong>${extractedCourses.length}</strong> 门课程`;
                            importResult.style.display = "block";
                            
                            // 暂存提取的课程
                            window.extractedCourses = extractedCourses;
                        } else {
                            statusText.textContent = "未识别到成绩信息，请手动添加";
                            extractedTable.innerHTML = "<p>未提取到课程数据，请检查文件或尝试手动输入。</p>";
                        }
                    });
                });
            };
            
            fileReader.readAsArrayBuffer(file);
        }
        
        // 从文本中提取课程信息
        function extractCoursesFromText(text) {
            // 这是一个简化的提取逻辑，实际应用中可能需要更复杂的处理
            const lines = text.split('\n');
            const courses = [];
            
            // 学分的正则表达式（支持小数）
            const creditRegex = /\b\d+(\.\d+)?\b/;
            
            // 成绩的正则表达式（支持数字和五级/二级分制）
            const scoreRegex = /\b(\d{1,3}|优秀|良好|中等|及格|不及格|合格|不合格)\b/;
            
            // 遍历每一行尝试提取课程信息
            lines.forEach(line => {
                line = line.trim();
                if (line.length < 5) return; // 跳过太短的行
                
                // 尝试匹配学分
                const creditMatch = line.match(creditRegex);
                if (!creditMatch) return;
                
                const credit = parseFloat(creditMatch[0]);
                if (credit < 0.25 || credit > 10) return; // 学分范围验证
                
                // 尝试匹配成绩
                const scoreMatch = line.match(scoreRegex);
                if (!scoreMatch) return;
                
                const scoreText = scoreMatch[0];
                
                // 提取课程名称（去掉学分和成绩后的部分）
                let courseName = line.replace(creditMatch[0], '').replace(scoreText, '').trim();
                // 清理课程名称中的特殊字符
                courseName = courseName.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\s]/g, '').trim();
                
                // 课程名称可以为空，会在导入时自动编号
                
                // 确定成绩类型
                const scoreType = determineScoreType(scoreText);
                
                // 计算转换后的成绩和绩点
                const percentScore = convertToPercentScore(scoreText, scoreType);
                const gpa = calculateGpa(percentScore);
                
                courses.push({
                    name: courseName || '',
                    originalScore: scoreText,
                    percentScore: percentScore,
                    credit: credit,
                    scoreType: scoreType,
                    gpa: gpa,
                    creditGpa: gpa * credit
                });
            });
            
            // 去重（简单处理，实际应用可能需要更复杂的逻辑）
            return courses.filter((course, index, self) => 
                index === self.findIndex(c => c.name === course.name && c.originalScore === course.originalScore)
            );
        }
        
        // 显示提取的课程数据
        function displayExtractedCourses(courses) {
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>课程名称</th>
                            <th>原始成绩</th>
                            <th>学分</th>
                            <th>是否导入</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            courses.forEach((course, index) => {
                html += `
                    <tr>
                        <td><input type="text" value="${course.name}" class="extracted-name" data-index="${index}"></td>
                        <td><input type="text" value="${course.originalScore}" class="extracted-score" data-index="${index}"></td>
                        <td><input type="number" min="0.25" max="10" step="0.25" value="${course.credit}" class="extracted-credit" data-index="${index}"></td>
                        <td><input type="checkbox" checked class="import-checkbox" data-index="${index}"></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            extractedTable.innerHTML = html;
        }
        
        // 确认导入选中的课程
        function confirmImport() {
            if (!window.extractedCourses) return;
            
            const checkboxes = document.querySelectorAll('.import-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('请至少选择一门课程导入');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const index = parseInt(checkbox.getAttribute('data-index'));
                
                // 获取可能被编辑过的值
                const name = document.querySelector(`.extracted-name[data-index="${index}"]`).value.trim();
                const scoreText = document.querySelector(`.extracted-score[data-index="${index}"]`).value.trim();
                const credit = parseFloat(document.querySelector(`.extracted-credit[data-index="${index}"]`).value);
                
                // 验证
                if (!scoreText || isNaN(credit) || credit < 0.25 || credit > 10) {
                    return;
                }
                
                // 确定成绩类型
                const scoreType = determineScoreType(scoreText);
                
                // 计算转换后的成绩和绩点
                const percentScore = convertToPercentScore(scoreText, scoreType);
                const gpa = calculateGpa(percentScore);
                
                // 如果名称为空，使用自动编号
                let courseName = name;
                if (!courseName) {
                    courseName = `课程${courses.length + 1}`;
                }
                
                // 添加到课程列表
                courses.push({
                    name: courseName,
                    originalScore: scoreText,
                    percentScore: percentScore,
                    credit: credit,
                    scoreType: scoreType,
                    gpa: gpa,
                    creditGpa: gpa * credit
                });
            });
            
            // 更新表格
            updateCoursesTable();
            
            // 提示用户
            alert(`成功导入 ${checkboxes.length} 门课程`);
            
            // 切换到手动输入标签页
            document.querySelector('.tab[data-tab="manual"]').click();
        }
    </script>
</body>
</html>
